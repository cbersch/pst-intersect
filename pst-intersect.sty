\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{pst-intersect}
    [2014/02/05 v0.1alpha]
\RequirePackage{pstricks}
\RequirePackage{pst-xkey}
\RequirePackage{pst-node}
\RequirePackage{multido}
\RequirePackage{pst-func}
\@addtofilelist{pst-intersect.pro}{}%
\pst@addfams{intersect}
\pstheader{pst-intersect.pro}

\def\pst@intersectdict{tx@IntersectDict begin }
\def\PIT@dict#1{\pst@intersectdict #1 end}
\def\PIT@Verb#1{\pst@Verb{\PIT@dict{#1} }}%

\def\intersectbeziers{\pst@object{intersectbeziers}}
\def\intersectbeziers@i{%
  \@ifnextchar\bgroup
    {\intersectbeziers@ii}{\intersectbeziers@iii}}%
\def\intersectbeziers@iii(#1)(#2)(#3)(#4)(#5)(#6)(#7)(#8){%
  \begin@SpecialObj
    \addto@pscode{%
      \pst@intersectdict }%
      \pst@@getcoor{#1}\addto@pscode{ [[\pst@coor] }%
      \pst@@getcoor{#2}\addto@pscode{ [\pst@coor] }%
      \pst@@getcoor{#3}\addto@pscode{ [\pst@coor] }%
      \pst@@getcoor{#4}\addto@pscode{ [\pst@coor]] }%
      \pst@@getcoor{#5}\addto@pscode{ [[\pst@coor] }%
      \pst@@getcoor{#6}\addto@pscode{ [\pst@coor] }%
      \pst@@getcoor{#7}\addto@pscode{ [\pst@coor] }%
      \pst@@getcoor{#8}\addto@pscode{ [\pst@coor]] }%
    \addto@pscode{%
      IntersectBeziers pop [ exch aload pop }%
    \psdots@ii
}%
\def\intersectbeziers@ii#1#2{%
  \begin@SpecialObj
    \addto@pscode{%
      \pst@intersectdict 
      #1 #2 IntersectBeziers pop [ exch aload pop }%
    \psdots@ii
}%

\def\savebezier#1{%
  \def\PIT@aftercurve{\let#1\PIT@tmpcurve}%
  \def\PIT@tmpcurve{[}%
  \savebezier@i}%
\def\savebezier@i{%
  \@ifnextchar(%)
    {\savebezier@ii}%
    {\edef\PIT@tmpcurve{\PIT@tmpcurve ]}\PIT@aftercurve}
}%
\def\savebezier@ii(#1){%
  \pst@@getcoor{#1}%
  \edef\PIT@tmpcurve{\PIT@tmpcurve [\pst@coor]}%
  \savebezier@i
}%
\define@key[psset]{intersect}{tstart}{%
  \pst@checknum{#1}\PIT@key@tstart
}
\define@key[psset]{intersect}{tstop}{%
  \pst@checknum{#1}\PIT@key@tstop
}
\define@key[psset]{intersect}{isectstart}{%
  \pst@checknum{#1}\PIT@key@isectstart
}
\define@key[psset]{intersect}{isectstop}{%
  \pst@checknum{#1}\PIT@key@isectstop
}
\define@key[psset]{intersect}{isectname}{%
  \def\PIT@key@isectname{#1}%
}
\psset[intersect]{%
  tstart=0,
  tstop=1,
  isectstart=0,
  isectstop=-1,
  isectname={}
}%
\def\showbezier{\pst@object{showbezier}}%
\def\showbezier@i#1{%
  \addbefore@par{plotpoints=200}%
  \begin@OpenObj
    \addto@pscode{%
      [#1 dup
      \PIT@key@tstart\space\PIT@key@tstop\space 
      \pst@intersectdict ToUnitInterval Portion end
      { aload pop } forall
      counttomark 2 sub 2 idiv
      \psk@plotpoints
      exch
      \txFunc@BezierCurve
      \ifshowpoints \txFunc@BezierShowPoints \else pop \fi
    }%
  \end@OpenObj
}%
\def\PIT@use@pscode{%
  \pstverb{%
    \pst@dict
    \tx@STP
    \pst@newpath
    \psk@origin
    \psk@swapaxes
    \pst@code
    end
    count /ocount exch def
  }%
  \gdef\pst@code{}%
}%
\let\PIT@pst@stroke@orig\pst@stroke
\def\PIT@pst@stroke{%
  \PIT@pst@stroke@orig
  \addto@pscode{%
    clear mark
    { /movetype counttomark 3 roll }
    { /linetype counttomark 3 roll }
    { /curvetype counttomark 7 roll }{} pathforall 
    counttomark 1 add -1 roll pop count }%
}%
\def\savepath{\pst@object{savepath}}%
\long\def\savepath@i#1{%
  \begin@SpecialObj
    \let\pst@stroke\PIT@pst@stroke
    \let\use@pscode\PIT@use@pscode
    \pscustom{#1}%
    \PIT@Verb{%
      \ifx\PIT@key@isectname\@empty
        /PIT@1
      \else
        /PIT@\PIT@key@isectname\space
      \fi
      [ 3 -1 roll 2 add 2 roll ] def }%
  \end@SpecialObj
\ignorespaces}%
\def\showpath{\pst@object{showpath}}%
\def\showpath@i{%
  \begin@SpecialObj
    \ifx\PIT@key@isectname\@empty
      \PackageError{pst-intersect}{You must provide an 'isectname' to show}%
    \fi
    \addto@pscode{%
      \pst@intersectdict 
      3 dict begin
        /movetype /moveto load def
        /linetype /lineto load def
        /curvetype /curveto load def
        mark PIT@\PIT@key@isectname\space aload pop
        {
          counttomark 0 eq { exit } if
          load exec
        } loop
        pop 
      end
    }%
    \pst@stroke
  \end@SpecialObj
\ignorespaces}%
\def\intersectpaths{\pst@object{intersectpaths}}%
\def\intersectpaths@i#1#2{%
  \begin@SpecialObj
    \addto@pscode{%
      \pst@intersectdict
      end
    }%
  \end@SpecialObj
\ignorespaces}%
\endinput
